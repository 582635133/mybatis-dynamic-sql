<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.8.1 from src/site/markdown/docs/springBatch.md at 07 April 2019
 | Rendered using Apache Maven Fluido Skin 1.7
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Date-Revision-yyyymmdd" content="20190407" />
    <meta http-equiv="Content-Language" content="en" />
    <title>MyBatis Dynamic SQL &#x2013; Spring Batch Support</title>
    <link rel="stylesheet" href="../css/apache-maven-fluido-1.7.min.css" />
    <link rel="stylesheet" href="../css/site.css" />
    <link rel="stylesheet" href="../css/print.css" media="print" />
    <script type="text/javascript" src="../js/apache-maven-fluido-1.7.min.js"></script>
  </head>
  <body class="topBarDisabled">
    <div class="container-fluid">
      <div id="banner">
        <div class="pull-left"><a href="../docs/introduction.html" id="bannerLeft"><h2>MyBatis Dynamic SQL</h2>
</a></div>
        <div class="pull-right"><a href="../../" id="bannerRight" title="MyBatis logo"><img src="http://mybatis.github.io/images/mybatis-logo.png"  alt="MyBatis logo"/></a></div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
        <li id="publishDate">Last Published: 07 April 2019<span class="divider">|</span>
</li>
          <li id="projectVersion">Version: 1.1.1</li>
        </ul>
      </div>
      <div class="row-fluid">
        <div id="leftColumn" class="span2">
          <div class="well sidebar-nav">
    <ul class="nav nav-list">
      <li class="nav-header">User's Guide</li>
    <li><a href="../docs/introduction.html" title="Introduction"><span class="none"></span>Introduction</a></li>
    <li><a href="../docs/CHANGELOG.html" title="Change Log"><span class="none"></span>Change Log</a></li>
    <li><a href="../docs/quickStart.html" title="Quick Start"><span class="none"></span>Quick Start</a></li>
    <li><a href="../docs/whereClauses.html" title="WHERE Clause Support"><span class="icon-chevron-down"></span>WHERE Clause Support</a>
    <ul class="nav nav-list">
    <li><a href="../docs/conditions.html" title="WHERE Conditions"><span class="none"></span>WHERE Conditions</a></li>
    </ul>
</li>
    <li><a href="../docs/select.html" title="SELECT Statements"><span class="none"></span>SELECT Statements</a></li>
    <li><a href="../docs/delete.html" title="DELETE Statements"><span class="none"></span>DELETE Statements</a></li>
    <li><a href="../docs/insert.html" title="INSERT Statements"><span class="none"></span>INSERT Statements</a></li>
    <li><a href="../docs/update.html" title="UPDATE Statements"><span class="none"></span>UPDATE Statements</a></li>
    <li><a href="../docs/mybatis3.html" title="MyBatis3 Support"><span class="none"></span>MyBatis3 Support</a></li>
    <li><a href="../docs/spring.html" title="Spring Support"><span class="none"></span>Spring Support</a></li>
    <li class="active"><a href="#"><span class="none"></span>Spring Batch Support</a></li>
    <li><a href="../docs/howItWorks.html" title="How it Works"><span class="none"></span>How it Works</a></li>
    <li><a href="../docs/extending.html" title="Extending the Library"><span class="none"></span>Extending the Library</a></li>
    <li><a href="../docs/codingStandards.html" title="Coding Standards"><span class="none"></span>Coding Standards</a></li>
    <li><a href="../docs/motivation.html" title="Motivation"><span class="none"></span>Motivation</a></li>
      <li class="nav-header">Project Documentation</li>
    <li><a href="../project-info.html" title="Project Information"><span class="icon-chevron-right"></span>Project Information</a></li>
    <li><a href="../project-reports.html" title="Project Reports"><span class="icon-chevron-right"></span>Project Reports</a></li>
</ul>
          <hr />
          <div id="poweredBy">
            <div class="clear"></div>
            <div class="clear"></div>
            <div class="clear"></div>
            <div class="clear"></div>
<a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy"><img class="builtBy" alt="Built by Maven" src="../images/logos/maven-feather.png" /></a>
            </div>
          </div>
        </div>
        <div id="bodyColumn"  class="span10" >
<h1>Spring Batch Support</h1>
<p>This library provides some utilities to make it easier to interact with the MyBatis Spring Batch support.</p>
<div class="section">
<h2><a name="The_Problem"></a>The Problem</h2>
<p>MyBatis Spring support provides utility classes for interacting with Spring Batch (see <a class="externalLink" href="http://www.mybatis.org/spring/batch.html">http://www.mybatis.org/spring/batch.html</a>). These classes are specialized implementations of Spring Batch&#x2019;s <tt>ItemReader</tt> and <tt>ItemWriter</tt> interfaces that have support for MyBatis mappers.</p>
<p>The <tt>ItemWriter</tt> implementations work with SQL generated by MyBatis Dynamic SQL with no modification needed.</p>
<p>The <tt>ItemReader</tt> implementations need special care. Those classes assume that all query parameters will be placed in a Map (as per usual when using multiple parameters in a query). MyBatis Dynamic SQL, by default, builds a parameter object that should be the only parameter in a query and will not work when placed in a Map of parameters.</p></div>
<div class="section">
<h2><a name="The_Solution"></a>The Solution</h2>
<p>The solution involves these steps:</p>
<ol style="list-style-type: decimal">

<li>The SQL must be rendered such that the parameter markers are aware of the enclosing parameter Map in the <tt>ItemReader</tt></li>
<li>The <tt>SelectStatamentProvider</tt> must be placed in the <tt>ItemReader</tt> parameter Map with a known key.</li>
<li>The <tt>@SelectProvider</tt> must be configured to be aware of the enclosing parameter Map</li>
</ol>
<p>MyBatis Dynamic SQL provides utilities for each of these requirements. Each utility uses a shared Map key for consistency.</p></div>
<div class="section">
<h2><a name="Spring_Batch_Item_Readers"></a>Spring Batch Item Readers</h2>
<p>MyBatis Spring support supplies two implementations of the <tt>ItemReader</tt> interface:</p>
<ol style="list-style-type: decimal">

<li><tt>org.mybatis.spring.batch.MyBatisCursorItemReader</tt> - for queries that can be efficiently processed through a single select statement and a cursor</li>
<li><tt>org.mybatis.spring.batch.MyBatisPagingItemReader</tt> - for queries that should be processed as a series of paged selects. Note that MyBatis does not provide any native support for paged queries - it is up to the user to write SQL for paging. The <tt>MyBatisPagingItemWriter</tt> simply makes properties available that specify which page should be read currently.</li>
</ol>
<p>MyBatis Dynamic SQL supplies specialized select statements that will render properly for the different implementations of <tt>ItemReader</tt>:</p>
<ol style="list-style-type: decimal">

<li><tt>SpringBatchUtility.selectForCursor(...)</tt> will create a select statement that is appropriate for the <tt>MyBatisCursorItemReader</tt> - a single select statement that will be read with a cursor</li>
<li><tt>SpringBatchUtility.selectForPaging(...)</tt> will create a select statement that is appropriate for the <tt>MyBatisPagingItemReader</tt> - a select statement that will be called multiple times - one for each page as configured on the batch job.</li>
</ol>
<p><b>Very Important:</b> The paging implementation will only work for databases that support limit and offset in select statements. Fortunately, most databases do support this - with the notable exception of Oracle.</p>
<div class="section">
<h3><a name="Rendering_for_Cursor"></a>Rendering for Cursor</h3>
<p>Queries intended for the <tt>MyBatisCursorItemReader</tt> should be rendered as follows:</p>

<div>
<div>
<pre class="source">  SelectStatementProvider selectStatement =  SpringBatchUtility.selectForCursor(person.allColumns())
      .from(person)
      .where(lastName, isEqualTo(&quot;flintstone&quot;))
      .build()
      .render(); // renders for MyBatisCursorItemReader
</pre></div></div>
</div>
<div class="section">
<h3><a name="Rendering_for_Paging"></a>Rendering for Paging</h3>
<p>Queries intended for the <tt>MyBatisPagingItemReader</tt> should be rendered as follows:</p>

<div>
<div>
<pre class="source">  SelectStatementProvider selectStatement =  SpringBatchUtility.selectForPaging(person.allColumns())
      .from(person)
      .where(lastName, isEqualTo(&quot;flintstone&quot;))
      .build()
      .render(); // renders for MyBatisPagingItemReader
</pre></div></div>
</div></div>
<div class="section">
<h2><a name="Creating_the_Parameter_Map"></a>Creating the Parameter Map</h2>
<p>The <tt>SpringBatchUtility</tt> provides a method to create the parameter values Map needed by the MyBatis Spring <tt>ItemReader</tt> implementations. It can be used as follows:</p>
<p>For cursor based queries&#x2026;</p>

<div>
<div>
<pre class="source">  MyBatisCursorItemReader&lt;Person&gt; reader = new MyBatisCursorItemReader&lt;&gt;();
  reader.setQueryId(PersonMapper.class.getName() + &quot;.selectMany&quot;);
  reader.setSqlSessionFactory(sqlSessionFactory);
  reader.setParameterValues(SpringBatchUtility.toParameterValues(selectStatement)); // create parameter map
</pre></div></div>

<p>For paging based queries&#x2026;</p>

<div>
<div>
<pre class="source">  MyBatisPagingItemReader&lt;Person&gt; reader = new MyBatisPagingItemReader&lt;&gt;();
  reader.setQueryId(PersonMapper.class.getName() + &quot;.selectMany&quot;);
  reader.setSqlSessionFactory(sqlSessionFactory);
  reader.setPageSize(7);
  reader.setParameterValues(SpringBatchUtility.toParameterValues(selectStatement)); // create parameter map
</pre></div></div>
</div>
<div class="section">
<h2><a name="Specialized_.40SelectProvider_Adapter"></a>Specialized @SelectProvider Adapter</h2>
<p>MyBatis mapper methods should be configured to use the specialized <tt>@SelectProvider</tt> adapter as follows:</p>

<div>
<div>
<pre class="source">  @SelectProvider(type=SpringBatchProviderAdapter.class, method=&quot;select&quot;) // use the Spring batch adapter
  @Results({
    @Result(column=&quot;id&quot;, property=&quot;id&quot;, id=true),
    @Result(column=&quot;first_name&quot;, property=&quot;firstName&quot;),
    @Result(column=&quot;last_name&quot;, property=&quot;lastName&quot;)
  })
  List&lt;Person&gt; selectMany(Map&lt;String, Object&gt; parameterValues);
</pre></div></div>
</div>
<div class="section">
<h2><a name="Complete_Example"></a>Complete Example</h2>
<p>The unit tests for MyBatis Dynamic SQL include a complete examples of using MyBatis Spring Batch support using the MyBatis supplied reader as well as both types of MyBatis supplied writers. You can see the full example here: <a class="externalLink" href="https://github.com/mybatis/mybatis-dynamic-sql/tree/master/src/test/java/examples/springbatch">https://github.com/mybatis/mybatis-dynamic-sql/tree/master/src/test/java/examples/springbatch</a></p></div>
        </div>
      </div>
    </div>
    <hr/>
    <footer>
      <div class="container-fluid">
        <div class="row-fluid">
            <p>Copyright &copy;2016&#x2013;2019
<a href="http://www.mybatis.org/">MyBatis.org</a>.
All rights reserved.</p>
        </div>
      </div>
    </footer>
  </body>
</html>
